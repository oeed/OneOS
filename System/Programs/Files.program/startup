tArgs = {...}

OneOS.LoadAPI('/System/API/Bedrock.lua', false)

local program = Bedrock:Initialise()

Current = {
	History = {},
	HistoryItem = 0,
	FileList = {},
	Path = tArgs[1] or '/Desktop/'
}

Settings = {
	ShowHidden = false,
	ListMode = false,
}

function WriteSettings()
	local h = fs.open('.Files.settings', 'w')
	h.write(textutils.serialize(Settings))
	h.close()
end

function ReadSettings()
	local h = fs.open('.Files.settings', 'r')
	if h then
		Settings = textutils.unserialize(h.readAll())
		h.close()
	else
		WriteSettings()
	end
end

function OptionsButtonClick(self, event, side, x, y)
	if self:ToggleMenu('optionsmenu') then
		if Settings.ListMode then
			program:GetObject('ViewModeMenuItem').Text = 'Icon View'
		end

		if Settings.ShowHidden then
			program:GetObject('HiddenFilesMenuItem').Text = 'Hide Hidden Files'
		end
	end
end

function SidebarClick(self, item, event, side, x, y)
	--term.setTextColour(colours.black)
end

function FileClick(item, event, side, x, y)
	if side == 1 then
		if OneOS.FS.isDir(item.Path) then
			GoToPath(item.Path)
		else
			OneOS.Helpers.OpenFile(item.Path)
			program:StartTimer(RefreshFiles, 1)
		end
	elseif side == 2 then
		if item:ToggleMenu('filemenu', x, y) then
			program:GetObject('OpenMenuItem').OnClick = function(_item)
				FileClick(item, event, 1, x, y)
			end

			program:GetObject('ViewProgramContentMenuItem').OnClick = function(_item)
				GoToPath(item.Path)
			end

			program:GetObject('OpenWithArgsMenuItem').OnClick = function(_item)
				program:DisplayTextBoxWindow("Program Arguments", 'Enter the arguments for the program separated by a space.', function(success, value)
					if success and #value ~= 0 then
						local tWords = {}
						for match in string.gmatch( value, "[^ \t]+" ) do
							table.insert( tWords, match )
						end
						OneOS.Run(item.Path, unpack(tWords))
					end
				end)
			end

			program:GetObject('OpenWithMenuItem').OnClick = function(_item)
				OneOS.Helpers.OpenFileWith(item.Path)
			end

			program:GetObject('TransmitMenuItem').OnClick = function(_item)
				OneOS.Run('/Programs/Transmit.program/', item.Path)
			end

			program:GetObject('CreatePackageMenuItem').OnClick = function(_item)
				local packrun = loadfile('pkgmake')
				local env = getfenv()
				setfenv( packrun, env)
				local path = item.Path:sub(1,#item.Path-1)
				packrun(item.Path, OneOS.Helpers.RemoveFileName(path)..OneOS.Helpers.RemoveExtension(OneOS.FS.getName(path))..'.pkg')
				RefreshFiles()
			end

			program:GetObject('RenameMenuItem').OnClick = function(_item)
				OneOS.Helpers.RenameFile(item.Path, RefreshFiles, program)
			end

			program:GetObject('DeleteMenuItem').OnClick = function(_item)
				OneOS.Helpers.DeleteFile(item.Path, RefreshFiles, program)
			end

			program:GetObject('AddToDesktopMenuItem').OnClick = function(_item)
				OneOS.Helpers.MakeShortcut(item.Path)
			end

			program:GetObject('CopyMenuItem').OnClick = function(_item)
				--TODO: clipboard
				Current.Clipboard.Copy(item.Path, 'filepath')
			end

			program:GetObject('CutMenuItem').OnClick = function(_item)
				Current.Clipboard.Cut(item.Path, 'filepath')
			end

			program:GetObject('NewFolderMenuItem').OnClick = function(_item)
				OneOS.Helpers.NewFolder(OneOS.Helpers.ParentFolder(item.Path)..'/', RefreshFiles, program)
			end

			program:GetObject('NewFileMenuItem').OnClick = function(_item)
				OneOS.Helpers.NewFile(OneOS.Helpers.ParentFolder(item.Path)..'/', RefreshFiles, program)
			end
			
			if OneOS.FS.isDir(item.Path) then
				program:RemoveObject('TransmitMenuItem')
			else
				program:RemoveObject('CreatePackageMenuItem')
			end

			if not OneOS.Helpers.Extension(item.Path) == 'program' or not OneOS.FS.isDir(item.Path) then
				program:RemoveObject('ViewProgramContentMenuItem')
				program:RemoveObject('OpenWithArgsMenuItem')
			else
				program:RemoveObject('OpenWithMenuItem')
			end
		end
	end
end


function RefreshFiles()
	diskOpenButton = nil
	program:GetObject('FilesListView').Items = {}

	for i, v in ipairs(OneOS.FS.list(Current.Path)) do
		if Settings.ShowHidden or string.sub( v, 1, 1 ) ~= '.' then
			local path = OneOS.Helpers.TidyPath(Current.Path .. '/' .. v)
			if path == '/rom/' then
				break
			end

			if Settings.ListMode then
				table.insert(program:GetObject('FilesListView').Items, {["Text"] = OneOS.FS.getName(path), ["Path"] = path, ["TextColour"] = OneOS.FS.isDir(path) and colours.grey or colours.black, OnClick = FileClick})
			end
		end
	end
	--Current.SidebarList.Peripherals = Peripheral.GetPeripherals()
end

function GoToPath(path, history)
	history = history or false
	local path = OneOS.Helpers.TidyPath(path)
	program:GetObject('PathLabel').Text = path
	if not history then
		for i, v in ipairs(Current.History) do
			if i >= Current.HistoryItem then
				Current.History[i] = nil
 			end
		end
		table.insert(Current.History, Current.Path)
		Current.HistoryItem = #Current.History + 1
	end
	Current.FileScroll = 0
	Current.Path = path
	if Current.History[Current.HistoryItem-1] then
		program:GetObject('BackButton').Enabled = true
	else
		program:GetObject('BackButton').Enabled = false
	end

	if Current.History[Current.HistoryItem+1] then
		program:GetObject('ForwardButton').Enabled = true
	else
		program:GetObject('ForwardButton').Enabled = false
	end
	RefreshFiles()
end

program:Run(function()
	program:LoadView('main')
	ReadSettings()
	GoToPath(Current.Path, true)
	program:GetObject('OptionsButton').OnClick = OptionsButtonClick
	program:GetObject('Sidebar').OnChildClick = SidebarClick

	program:GetObject('BackButton').OnClick = function(self)
		if Current.History[Current.HistoryItem-1] then
			table.insert(Current.History, Current.Path)
			Current.HistoryItem = Current.HistoryItem - 1
			GoToPath(Current.History[Current.HistoryItem], true)
		end
	end

	program:GetObject('ForwardButton').OnClick = function(self)
		if Current.History[Current.HistoryItem+1] then
			Current.HistoryItem = Current.HistoryItem + 1
			GoToPath(Current.History[Current.HistoryItem], true)
		end
	end
end)

